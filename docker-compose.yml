services:
  frontend:
    build:
      context: ./easy-risk-register-frontend
      dockerfile: Dockerfile
    ports:
      - "3001:8080"
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    # Health check to ensure the application is running properly
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend-dev:
    build:
      context: ./easy-risk-register-frontend
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      # Mount the source code for hot reloading
      - ./easy-risk-register-frontend:/app
      # Avoid conflicts with local node_modules
      - /app/node_modules
    environment:
      - NODE_ENV=development
    restart: unless-stopped
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    profiles:
      - development

  # Supabase (dev only)
  # Minimal local stack to support serverless `/api/timeseries/*` via PostgREST + a small gateway that exposes `/rest/v1`.
  supabase-db:
    image: supabase/postgres:15.1.0.117
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - "54322:5432"
    volumes:
      - supabase_db_data:/var/lib/postgresql/data
      - ./supabase/init:/docker-entrypoint-initdb.d:ro
    networks:
      default:
        aliases:
          # Some Supabase services expect the DB hostname to be `db` (official compose naming).
          - db
    profiles:
      - development

  supabase-rest:
    image: postgrest/postgrest:v12.2.0
    restart: unless-stopped
    depends_on:
      - supabase-db
    environment:
      - PGRST_DB_URI=postgres://postgres:postgres@supabase-db:5432/postgres
      - PGRST_DB_SCHEMAS=public
      - PGRST_DB_ANON_ROLE=anon
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET:-dev-supabase-jwt-secret}
      - PGRST_SERVER_PORT=3000
    profiles:
      - development

  supabase-auth:
    image: supabase/gotrue:v2.177.0
    restart: unless-stopped
    depends_on:
      - supabase-db
    environment:
      - GOTRUE_API_HOST=0.0.0.0
      - GOTRUE_API_PORT=9999
      # Required by GoTrue v2 (used for redirects/email links).
      - API_EXTERNAL_URL=http://localhost:54321/auth/v1
      - GOTRUE_API_EXTERNAL_URL=http://localhost:54321/auth/v1
      - GOTRUE_DB_DRIVER=postgres
      # Use a dedicated superuser role with a search_path that includes `auth` so GoTrue migrations
      # that create types without schema qualification land in the correct namespace.
      - GOTRUE_DB_DATABASE_URL=postgres://supabase_admin:postgres@supabase-db:5432/postgres?options=-c%20search_path%3Dauth%2Cpublic
      # In this minimal local stack, using the `public` namespace avoids migration issues
      # where some auth types are created without schema qualification.
      - GOTRUE_DB_NAMESPACE=public
      - DB_NAMESPACE=public
      - GOTRUE_SITE_URL=http://localhost:3000
      - GOTRUE_URI_ALLOW_LIST=*
      - GOTRUE_DISABLE_SIGNUP=false
      - GOTRUE_JWT_SECRET=${SUPABASE_JWT_SECRET:-dev-supabase-jwt-secret}
      - GOTRUE_JWT_EXP=3600
      # Required for email/password signups.
      - GOTRUE_EXTERNAL_EMAIL_ENABLED=true
      - GOTRUE_EXTERNAL_PHONE_ENABLED=false
      - GOTRUE_MAILER_AUTOCONFIRM=true
    profiles:
      - development

  supabase-storage:
    image: supabase/storage-api:v1.22.13
    restart: unless-stopped
    depends_on:
      - supabase-db
      - supabase-rest
    environment:
      - ANON_KEY=${SUPABASE_ANON_KEY:-__MISSING_SUPABASE_ANON_KEY__}
      - SERVICE_KEY=${SUPABASE_SERVICE_KEY:-__MISSING_SUPABASE_SERVICE_KEY__}
      - POSTGREST_URL=http://supabase-rest:3000
      - PGRST_JWT_SECRET=${SUPABASE_JWT_SECRET:-dev-supabase-jwt-secret}
      - DATABASE_URL=postgres://postgres:postgres@supabase-db:5432/postgres
      - FILE_SIZE_LIMIT=52428800
      - STORAGE_BACKEND=file
      - FILE_STORAGE_BACKEND_PATH=/var/lib/storage
      - TENANT_ID=local
      - REGION=local
      - GLOBAL_S3_BUCKET=local
      - ENABLE_IMAGE_TRANSFORMATION=false
    volumes:
      - supabase_storage_data:/var/lib/storage
    profiles:
      - development

  supabase-realtime:
    image: supabase/realtime:v2.35.2
    restart: unless-stopped
    depends_on:
      - supabase-db
    environment:
      - APP_NAME=realtime
      - PORT=4000
      - RLIMIT_NOFILE=1048576
      - DB_HOST=supabase-db
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=postgres
      - DB_SSL=false
      - JWT_SECRET=${SUPABASE_JWT_SECRET:-dev-supabase-jwt-secret}
      - SECRET_KEY_BASE=dev-secret-key-base-change-me
      - ERL_AFLAGS=-proto_dist inet_tcp
    profiles:
      - development

  supabase-gateway:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      - supabase-rest
      - supabase-auth
      - supabase-storage
    ports:
      - "54321:80"
    volumes:
      - ./supabase/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    profiles:
      - development

  # Supabase Studio (dev only UI). Note: this repo runs a minimal Supabase-compatible stack
  # (DB + PostgREST + gateway). Studio features that depend on Auth/Storage/etc won't work
  # unless you run a full Supabase stack.
  supabase-meta:
    image: public.ecr.aws/supabase/postgres-meta:v0.95.1
    restart: unless-stopped
    depends_on:
      - supabase-db
    environment:
      - PG_META_PORT=8080
      - PG_META_DB_HOST=supabase-db
      - PG_META_DB_PORT=5432
      - PG_META_DB_NAME=postgres
      - PG_META_DB_USER=postgres
      - PG_META_DB_PASSWORD=postgres
    profiles:
      - development

  supabase-studio:
    image: public.ecr.aws/supabase/studio:2025.12.09-sha-434634f
    restart: unless-stopped
    depends_on:
      - supabase-meta
      - supabase-db
      - supabase-gateway
    ports:
      - "54323:3000"
    environment:
      - STUDIO_PG_META_URL=http://supabase-meta:8080
      - POSTGRES_PASSWORD=postgres
      - JWT_SECRET=${SUPABASE_JWT_SECRET:-dev-supabase-jwt-secret}
      - SUPABASE_URL=http://supabase-gateway
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-__MISSING_SUPABASE_ANON_KEY__}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY:-__MISSING_SUPABASE_SERVICE_KEY__}
      - DEFAULT_ORGANIZATION_NAME=Easy Risk Register
      - DEFAULT_PROJECT_NAME=Local Dev
    profiles:
      - development

volumes:
  supabase_db_data:
  supabase_storage_data:
