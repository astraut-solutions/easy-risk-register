version: '3.8'

services:
  frontend:
    build:
      context: ./easy-risk-register-frontend
      dockerfile: Dockerfile
    ports:
      - "3001:8080"
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    # Health check to ensure the application is running properly
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend-dev:
    build:
      context: ./easy-risk-register-frontend
      dockerfile: Dockerfile.dev
    ports:
      - "5173:5173"
    volumes:
      # Mount the source code for hot reloading
      - ./easy-risk-register-frontend:/app
      # Avoid conflicts with local node_modules
      - /app/node_modules
    environment:
      - NODE_ENV=development
    restart: unless-stopped
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    profiles:
      - development

  # Supabase (dev only)
  # Minimal local stack to support serverless `/api/timeseries/*` via PostgREST + a small gateway that exposes `/rest/v1`.
  supabase-db:
    image: supabase/postgres:15.1.0.117
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    ports:
      - "54322:5432"
    volumes:
      - supabase_db_data:/var/lib/postgresql/data
      - ./supabase/init:/docker-entrypoint-initdb.d:ro
    profiles:
      - development

  supabase-rest:
    image: postgrest/postgrest:v12.2.0
    restart: unless-stopped
    depends_on:
      - supabase-db
    environment:
      - PGRST_DB_URI=postgres://postgres:postgres@supabase-db:5432/postgres
      - PGRST_DB_SCHEMAS=public
      - PGRST_DB_ANON_ROLE=anon
      - PGRST_JWT_SECRET=dev-supabase-jwt-secret
      - PGRST_SERVER_PORT=3000
    profiles:
      - development

  supabase-gateway:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      - supabase-rest
    ports:
      - "54321:80"
    volumes:
      - ./supabase/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    profiles:
      - development

volumes:
  supabase_db_data:
