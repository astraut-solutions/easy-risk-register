server {
  listen 80;
  server_name _;

  # Docker DNS (delayed resolution so gateway can start even if `supabase-rest` isn't ready yet).
  resolver 127.0.0.11 ipv6=off valid=10s;

  # Minimal CORS for local development (Vite runs on a different origin).
  set $cors_allow_origin $http_origin;
  if ($cors_allow_origin = "") {
    set $cors_allow_origin "*";
  }

  add_header Vary Origin always;
  add_header Access-Control-Allow-Origin $cors_allow_origin always;
  add_header Access-Control-Allow-Credentials "true" always;
  add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
  add_header Access-Control-Allow-Headers "Authorization, Content-Type, apikey, x-client-info, x-supabase-api-version, x-workspace-id" always;

  if ($request_method = OPTIONS) {
    return 204;
  }

  # Auth (GoTrue)
  location /auth/v1/ {
    set $gotrue_upstream supabase-auth:9999;
    rewrite ^/auth/v1/?(.*)$ /$1 break;
    proxy_pass http://$gotrue_upstream;
    # Prevent duplicate CORS headers when the upstream also sets them.
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Storage
  location /storage/v1/ {
    set $storage_upstream supabase-storage:5000;
    rewrite ^/storage/v1/?(.*)$ /$1 break;
    proxy_pass http://$storage_upstream;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Realtime (WebSocket + HTTP)
  location /realtime/v1/ {
    set $realtime_upstream supabase-realtime:4000;
    rewrite ^/realtime/v1/?(.*)$ /$1 break;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_pass http://$realtime_upstream;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Mimic Supabase REST base path so `@supabase/supabase-js` can use `SUPABASE_URL=http://localhost:54321`.
  location /rest/v1/ {
    set $postgrest_upstream supabase-rest:3000;
    rewrite ^/rest/v1/?(.*)$ /$1 break;
    proxy_pass http://$postgrest_upstream;
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Basic health endpoint for local debugging.
  location /health {
    return 200 "ok\n";
    add_header Content-Type text/plain;
  }
}
